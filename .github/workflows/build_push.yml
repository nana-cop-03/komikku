name: CI

on:
  push:
    branches: [ master ]
    paths:
      - '**'
      - '!**.md'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

# -------------------------
# 1️⃣ PREPARE JOB
# -------------------------
jobs:
  prepare:
    name: Prepare environment
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: temurin

      - name: Write optional Firebase stubs
        run: |
          mkdir -p app/src/main/assets
          [ -f app/google-services.json ] || echo '{}' > app/google-services.json
          [ -f app/src/main/assets/client_secrets.json ] || echo '{}' > app/src/main/assets/client_secrets.json

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > app/nanacomik.keystore

      - uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

# -------------------------
# 2️⃣ BUILD JOB
# -------------------------
  build:
    name: Build APK
    runs-on: ubuntu-24.04
    needs: prepare

    outputs:
      apk_name: ${{ steps.rename.outputs.APK_NAME }}
      version_tag: ${{ steps.rename.outputs.VERSION_TAG }}
      commit_count: ${{ steps.rename.outputs.COMMIT_COUNT }}

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: temurin

      - uses: gradle/actions/setup-gradle@v5

      - name: Spotless check
        run: ./gradlew spotlessCheck

      - name: Build app
        run: ./gradlew assemblePreview -Penable-updater
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: List APK outputs
        run: ls -R app/build/outputs/apk

      - name: Rename APK
        id: rename
        run: |
          set -e

          VERSION_TAG="${GITHUB_REF_NAME//[^a-zA-Z0-9]/_}"
          COMMIT_COUNT=$(git rev-list --count HEAD)

          echo "Searching for APKs..."
          find app/build/outputs/apk -type f -name "*.apk"

          APK_PATH=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1)

          if [ -z "$APK_PATH" ]; then
            echo "APK not found"
            exit 1
          fi

          APK_NAME="Nana-Comik-${VERSION_TAG}-r${COMMIT_COUNT}.apk"
          mv "$APK_PATH" "$APK_NAME"

          echo "APK_NAME=$APK_NAME" >> "$GITHUB_OUTPUT"
          echo "VERSION_TAG=$VERSION_TAG" >> "$GITHUB_OUTPUT"
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> "$GITHUB_OUTPUT"


      - name: Upload APK artifact
        uses: actions/upload-artifact@v5
        with:
          name: apk
          path: Nana-Comik-*.apk

      - name: Upload mapping
        uses: actions/upload-artifact@v5
        with:
          name: mapping
          path: app/build/outputs/mapping/preview

# -------------------------
# 3️⃣ TEST JOB
# -------------------------
  test:
    name: Run tests
    runs-on: ubuntu-24.04
    needs: build

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: temurin
      - uses: gradle/actions/setup-gradle@v5

      - run: ./gradlew testReleaseUnitTest

# -------------------------
# 4️⃣ DISTRIBUTE JOB
# -------------------------
  distribute:
    name: Telegram distribution
    runs-on: ubuntu-24.04
    needs: [build, test]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: apk

      - name: Send APK to Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 scripts/send-to-telegram.py \
            "$TG_BOT_TOKEN" \
            "$TG_CHAT_ID" \
            "${{ needs.build.outputs.apk_name }}" \
            "${{ needs.build.outputs.version_tag }}" \
            "${{ needs.build.outputs.commit_count }}"
